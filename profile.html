<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edenwood — Profil</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="assets/style.css" />
</head>

<body>
  <div class="overlay">
    <div class="wrap">
      <h1>Edenwood</h1>
      <p class="subtitle">Bienvenue, voyageur·se.</p>

      <div class="panel">
        <div class="info"><strong>Pseudo :</strong> <span id="pseudoText">—</span></div>
        <div class="info"><strong>Email :</strong> <span id="emailText">—</span></div>
        <div class="info"><strong>Rang :</strong> Éveillé</div>
        <div class="info"><strong>Affinité :</strong> Forêt ancienne</div>
        <div class="info"><strong>Carte liée :</strong> À venir…</div>

        <div class="info" style="text-align:center;">
          <strong>Paramètres</strong><br/>
          <span style="opacity:.85;">Modifier ton pseudo, ton email ou ton mot de passe</span>
        </div>

        <input id="newPseudo" type="text" placeholder="Nouveau pseudo" />
        <button id="btnSavePseudo" type="button">Enregistrer le pseudo</button>

        <input id="newEmail" type="email" placeholder="Nouvel email" />
        <button id="btnChangeEmail" type="button">Changer l’email</button>

        <input id="newPass" type="password" placeholder="Nouveau mot de passe (6+)" />
        <input id="newPass2" type="password" placeholder="Confirmer le mot de passe" />
        <button id="btnChangePass" type="button">Changer le mot de passe</button>

        <div id="status"></div>

        <a class="btn" href="index.html">Retour à l’accueil</a>
        <button id="btnLogout" type="button">Changer de voyageur</button>

        <nav>
          <a href="index.html">Accueil</a>
          <a href="profile.html">Profil</a>
          <a id="linkLogout" href="#">Déconnexion</a>
        </nav>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://skwjxawyznwmmlvfepfn.supabase.co";
    const SUPABASE_KEY = "sb_publishable_8t8bVf4UHqKa4yNBdcJ9Og_VrZnpDKy";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const pseudoText = document.getElementById("pseudoText");
    const emailText  = document.getElementById("emailText");
    const statusEl   = document.getElementById("status");

    function setStatus(msg, isError=false){
      statusEl.textContent = msg;
      statusEl.className = isError ? "error" : "";
    }

    async function requireAuth(){
      const { data } = await supabase.auth.getSession();
      if (!data.session) window.location.href = "login.html";
      return data.session;
    }

    async function refreshUser(){
      // ⚠️ Important : getUser() est plus fiable que session.user pour l’email après changement
      const { data, error } = await supabase.auth.getUser();
      if (error) throw error;
      return data.user;
    }

    async function loadProfile(){
      await requireAuth();
      const user = await refreshUser();

      const pseudo = user.user_metadata?.pseudo || "—";
      pseudoText.textContent = pseudo;
      emailText.textContent = user.email || "—";

      const inputPseudo = document.getElementById("newPseudo");
      if (inputPseudo && pseudo !== "—") inputPseudo.value = pseudo;
    }

    // Pseudo (user_metadata)
    document.getElementById("btnSavePseudo").addEventListener("click", async () => {
      const val = document.getElementById("newPseudo").value.trim();
      if (!val) return setStatus("Entre un pseudo.", true);

      const { error } = await supabase.auth.updateUser({ data: { pseudo: val } });
      if (error) return setStatus(error.message, true);

      setStatus("Pseudo enregistré ✅");
      await loadProfile();
    });

    // Email (demande de confirmation)
    document.getElementById("btnChangeEmail").addEventListener("click", async () => {
      const newEmail = document.getElementById("newEmail").value.trim();
      if (!newEmail) return setStatus("Entre un email.", true);

      const emailRedirectTo = new URL("confirm.html", window.location.href);
      // Supabase mettra type/token_hash dans l’URL de redirection automatique via son template
      // Nous on force juste la page confirm.html
      const { error } = await supabase.auth.updateUser(
        { email: newEmail },
        { emailRedirectTo: emailRedirectTo.toString() }
      );

      if (error) return setStatus(error.message, true);

      setStatus("Email : demande envoyée ✅ Vérifie ta boîte mail (et les spams).");
    });

    // Mot de passe
    document.getElementById("btnChangePass").addEventListener("click", async () => {
      const p1 = document.getElementById("newPass").value;
      const p2 = document.getElementById("newPass2").value;

      if (!p1 || p1.length < 6) return setStatus("Mot de passe : 6 caractères minimum.", true);
      if (p1 !== p2) return setStatus("Les mots de passe ne correspondent pas.", true);

      const { error } = await supabase.auth.updateUser({ password: p1 });
      if (error) return setStatus(error.message, true);

      setStatus("Mot de passe changé ✅");
      document.getElementById("newPass").value = "";
      document.getElementById("newPass2").value = "";
    });

    // Logout (bouton)
    document.getElementById("btnLogout").addEventListener("click", async (e) => {
      e.preventDefault();
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    // Logout (lien nav)
    document.getElementById("linkLogout").addEventListener("click", async (e) => {
      e.preventDefault();
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    loadProfile();
  </script>
</body>
</html>
