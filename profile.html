<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edenwood — Profil</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="assets/style.css">
</head>

<body>
  <div class="overlay">
    <div class="wrap">
      <h1>Edenwood</h1>
      <p class="subtitle">Bienvenue, voyageur·se.</p>

      <div class="panel">
        <div class="info"><strong>Pseudo :</strong> <span id="pseudo">—</span></div>
        <div class="info"><strong>Email :</strong> <span id="email">—</span></div>

        <!-- affichage optionnel si Supabase indique un nouvel email en attente -->
        <div class="info" id="pendingBox" style="display:none;">
          <strong>Changement en attente :</strong>
          <span id="pendingEmail"></span><br/>
          <span style="opacity:.85">Confirme via l’email reçu, puis reconnecte-toi.</span>
        </div>

        <div class="info"><strong>Rang :</strong> <span id="rang">Éveillé</span></div>
        <div class="info"><strong>Affinité :</strong> <span id="affinite">Forêt ancienne</span></div>
        <div class="info"><strong>Carte liée :</strong> <span id="carte">À venir…</span></div>

        <div class="info" style="text-align:center;">
          <strong style="display:block; margin-bottom:4px;">Paramètres</strong>
          <span style="opacity:.85;">Modifier ton pseudo, ton email ou ton mot de passe</span>
        </div>

        <!-- PSEUDO -->
        <input id="newPseudo" type="text" placeholder="Nouveau pseudo" />
        <button id="btnSavePseudo" type="button">Enregistrer le pseudo</button>

        <!-- EMAIL -->
        <input id="newEmail" type="email" placeholder="Nouvel email" />
        <button id="btnChangeEmail" type="button">Changer l’email</button>

        <!-- MDP -->
        <input id="newPass" type="password" placeholder="Nouveau mot de passe (6+)" />
        <input id="newPass2" type="password" placeholder="Confirmer le mot de passe" />
        <button id="btnChangePass" type="button">Changer le mot de passe</button>

        <div id="status"></div>

        <a class="btn" href="index.html">Retour à l’accueil</a>
        <a class="btn secondary" href="login.html">Changer de voyageur</a>

        <nav class="nav" style="margin-top:18px;">
          <a href="index.html">Accueil</a>
          <a href="profile.html">Profil</a>
          <a href="#" id="logoutLink">Déconnexion</a>
        </nav>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://skwjxawyznwmmlvfepfn.supabase.co";
    const SUPABASE_KEY = "sb_publishable_8t8bVf4UHqKa4yNBdcJ9Og_VrZnpDKy";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const pseudoEl = document.getElementById("pseudo");
    const emailEl  = document.getElementById("email");
    const statusEl = document.getElementById("status");

    const pendingBox = document.getElementById("pendingBox");
    const pendingEmailEl = document.getElementById("pendingEmail");

    function setStatus(text, isError=false){
      statusEl.textContent = text;
      statusEl.className = isError ? "error" : "";
    }

    async function loadProfile(){
      // session obligatoire
      const { data: sessionData } = await supabase.auth.getSession();
      if(!sessionData.session){
        window.location.href = "login.html?message=" + encodeURIComponent("Connecte-toi pour accéder au profil.");
        return;
      }

      // user frais
      const { data: userData, error } = await supabase.auth.getUser();
      if(error || !userData?.user){
        window.location.href = "login.html?message=" + encodeURIComponent("Session invalide. Reconnecte-toi.");
        return;
      }

      const user = userData.user;

      // pseudo dans metadata (si tu l’utilises)
      const pseudo = user.user_metadata?.pseudo || user.user_metadata?.username || "—";
      pseudoEl.textContent = pseudo;

      // email actuel
      emailEl.textContent = user.email || "—";

      // email en attente (si fourni)
      const pending = user.new_email || user.email_change_new_email || null;
      if(pending && pending !== user.email){
        pendingBox.style.display = "block";
        pendingEmailEl.textContent = pending;
      } else {
        pendingBox.style.display = "none";
      }

      // préremplissage pseudo
      document.getElementById("newPseudo").value = pseudo !== "—" ? pseudo : "";
    }

    // Actions
    document.getElementById("btnSavePseudo").addEventListener("click", async () => {
      const newPseudo = document.getElementById("newPseudo").value.trim();
      if(!newPseudo) return setStatus("Entre un pseudo.", true);

      const { error } = await supabase.auth.updateUser({
        data: { pseudo: newPseudo }
      });

      if(error) return setStatus(error.message, true);
      setStatus("Pseudo enregistré ✅");
      await loadProfile();
    });

    document.getElementById("btnChangeEmail").addEventListener("click", async () => {
      const newEmail = document.getElementById("newEmail").value.trim();
      if(!newEmail) return setStatus("Entre un nouvel email.", true);

      const { error } = await supabase.auth.updateUser({ email: newEmail });
      if(error) return setStatus(error.message, true);

      setStatus("Email : demande envoyée ✅ Vérifie ta boîte mail (et les spams).");
      // on recharge pour éventuellement afficher "en attente"
      await loadProfile();
    });

    document.getElementById("btnChangePass").addEventListener("click", async () => {
      const p1 = document.getElementById("newPass").value;
      const p2 = document.getElementById("newPass2").value;
      if(!p1 || p1.length < 6) return setStatus("Mot de passe : 6 caractères minimum.", true);
      if(p1 !== p2) return setStatus("Les mots de passe ne correspondent pas.", true);

      const { error } = await supabase.auth.updateUser({ password: p1 });
      if(error) return setStatus(error.message, true);

      setStatus("Mot de passe changé ✅");
      document.getElementById("newPass").value = "";
      document.getElementById("newPass2").value = "";
    });

    document.getElementById("logoutLink").addEventListener("click", async (e) => {
      e.preventDefault();
      await supabase.auth.signOut();
      window.location.href = "index.html";
    });

    loadProfile();
  </script>
</body>
</html>
